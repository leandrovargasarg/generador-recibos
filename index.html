<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Recibos - Cuota Social</title>
    <!-- Incluyendo Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluyendo las librerías para PDF (html2canvas, jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para la impresión del recibo */
        @media print {
            body * {
                visibility: hidden;
            }
            #recibo, #recibo * {
                visibility: visible;
            }
            #recibo {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
                margin: 0;
                padding: 0;
            }
        }
        /* Ocultar flechas en input de tipo number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Contenedor principal -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Notificación personalizada -->
        <div id="notification" class="fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 z-50">
            Mensaje
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Generador de Recibos - Cuota Social</h1>
                <p class="text-gray-500 mt-2">Los datos se cargan automáticamente desde la planilla en línea.</p>
            </div>

            <!-- Formulario de Recibo -->
            <form id="reciboForm" class="space-y-6">
                <input type="hidden" id="telefonoSocio">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Campo de búsqueda de DNI -->
                    <div class="relative">
                        <label for="dniSearchInput" class="block text-sm font-medium text-gray-700">1. Buscar DNI del Aportante:</label>
                        <input type="text" id="dniSearchInput" placeholder="Cargando datos de socios..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-200" required disabled autocomplete="off">
                        <div id="dniSearchResults" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-48 overflow-y-auto hidden">
                            <!-- Los resultados de la búsqueda aparecerán aquí -->
                        </div>
                    </div>
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre del Aportante:</label>
                        <input type="text" id="nombre" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" required readonly>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="gradoCurso" class="block text-sm font-medium text-gray-700">Grado y Curso (Alumno):</label>
                        <input type="text" id="gradoCurso" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" required readonly>
                    </div>
                    <div>
                        <label for="mesPago" class="block text-sm font-medium text-gray-700">Mes de pago:</label>
                        <select id="mesPago" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            <option>AGOSTO</option>
                            <option>SEPTIEMBRE</option>
                            <option>OCTUBRE</option>
                            <option>NOVIEMBRE</option>
                            <option>DICIEMBRE</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="cuota" class="block text-sm font-medium text-gray-700">Cuota Social ($):</label>
                        <input type="number" id="cuota" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" required readonly>
                    </div>
                    <div>
                        <label for="donacion" class="block text-sm font-medium text-gray-700">Donacion ($):</label>
                        <input type="number" id="donacion" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" required readonly>
                    </div>
                </div>
                
                <div>
                    <label for="fechaPago" class="block text-sm font-medium text-gray-700">Fecha de Pago:</label>
                    <input type="date" id="fechaPago" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <div>
                    <label for="aportante" class="block text-sm font-medium text-gray-700">Recibo a nombre de (si es distinto):</label>
                    <input type="text" id="aportante" placeholder="Dejar en blanco si es el mismo aportante" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">
                        Generar Recibo
                    </button>
                </div>
            </form>
        </div>

        <!-- Contenedor del Recibo (inicialmente oculto) -->
        <div id="reciboContainer" class="mt-8" style="display:none;">
            <div id="recibo" class="bg-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto border">
                <!-- El contenido del recibo se insertará aquí -->
            </div>
            <div id="botonesRecibo" class="text-center mt-6 flex flex-wrap justify-center gap-4">
                <button onclick="window.print()" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800 transition-colors">Imprimir</button>
                <button id="pdfBtn" onclick="descargarPDF()" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Descargar PDF</button>
                <button id="whatsappBtn" onclick="enviarPorWhatsApp()" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Enviar por WhatsApp</button>
                <button onclick="limpiarFormulario()" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors mt-4 md:mt-0">Limpiar</button>
            </div>
        </div>
    </div>

    <script>
        let sociosData = [];
        const dniSearchInput = document.getElementById("dniSearchInput");
        const dniSearchResults = document.getElementById("dniSearchResults");

        // --- Función para mostrar notificaciones ---
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('bg-blue-500', 'bg-red-500', 'opacity-0');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-blue-500', 'opacity-100');
            
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
            }, 3000);
        }
        
        // --- Función para formatear fechas de Excel ---
        function formatExcelDate(excelDate) {
            if (!excelDate || String(excelDate).trim() === '') {
                return new Date().toISOString().split('T')[0];
            }
            if (!isNaN(excelDate) && excelDate > 1) {
                const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                return date.toISOString().split('T')[0];
            }
            if (typeof excelDate === 'string') {
                const parts = excelDate.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
            }
            return new Date().toISOString().split('T')[0];
        }

        // --- Lógica de inicialización al cargar la página ---
        document.addEventListener('DOMContentLoaded', async (event) => {
            const meses = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
            const mesActual = new Date().getMonth();
            const mesSelect = document.getElementById('mesPago');
            mesSelect.innerHTML = '<option>AGOSTO</option><option>SEPTIEMBRE</option><option>OCTUBRE</option><option>NOVIEMBRE</option><option>DICIEMBRE</option>';
            if (mesActual >= 7) { 
                mesSelect.value = meses[mesActual];
            } else {
                mesSelect.value = 'AGOSTO';
            }
            document.getElementById('fechaPago').valueAsDate = new Date();

            const googleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTnI6tprCDmbACfSNauw9vGj74MKAPr8PLaL6Xt-AxqsMHSvsukmz-m1gCt8105AA/pub?gid=709970478&single=true&output=csv";

            try {
                const response = await fetch(`${googleSheetUrl}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                
                const csvData = await response.text();
                const rows = csvData.trim().split('\n');
                
                // REPARACION: Lógica de lectura de encabezados mejorada
                let monthHeaderRowIndex = -1;
                let fieldHeaderRowIndex = -1;

                for (let i = 0; i < rows.length; i++) {
                    const upperRow = rows[i].trim().toUpperCase();
                    if (upperRow.includes("AGOSTO") && !upperRow.includes("GRADO")) {
                        monthHeaderRowIndex = i;
                    }
                    if (upperRow.includes("GRADO") && upperRow.includes("DNI")) {
                        fieldHeaderRowIndex = i;
                        break; 
                    }
                }

                if (fieldHeaderRowIndex === -1 || monthHeaderRowIndex === -1) {
                    throw new Error("No se encontraron las filas de encabezado en la planilla.");
                }

                const monthHeaderRow = rows[monthHeaderRowIndex].trim().split(',');
                const fieldHeaderRow = rows[fieldHeaderRowIndex].trim().split(',');
                const dataStartIndex = fieldHeaderRowIndex + 1;
                
                const monthColumnMap = {};
                let currentMonth = '';
                monthHeaderRow.forEach((cell, index) => {
                    if (cell.trim() !== '') {
                        currentMonth = cell.trim().toUpperCase();
                    }
                    if (currentMonth && !monthColumnMap[currentMonth]) {
                        monthColumnMap[currentMonth] = {};
                    }
                    if(currentMonth) {
                        const fieldName = fieldHeaderRow[index] ? fieldHeaderRow[index].trim().toLowerCase() : '';
                        if (fieldName === 'cuota') monthColumnMap[currentMonth].cuotaIndex = index;
                        if (fieldName === 'donacion') monthColumnMap[currentMonth].donacionIndex = index;
                        if (fieldName === 'fecha pago') monthColumnMap[currentMonth].fechaPagoIndex = index;
                    }
                });

                const dataRows = rows.slice(dataStartIndex);
                
                sociosData = dataRows.map(row => {
                    const columns = row.split(',');
                    if (columns.length > 4 && columns[4] && String(columns[4]).trim()) {
                        const socio = {
                            gradoCurso: columns[0] || '',
                            nombre: columns[3] || '',
                            dni: String(columns[4]).trim(),
                            telefono: columns[9] ? String(columns[9]).replace(/\D/g, '') : null,
                            pagos: {}
                        };

                        for (const month in monthColumnMap) {
                            const indices = monthColumnMap[month];
                            socio.pagos[month] = {
                                cuota: (columns[indices.cuotaIndex] || '0').replace(/\D/g, ''),
                                donacion: (columns[indices.donacionIndex] || '0').replace(/\D/g, ''),
                                fechaPago: columns[indices.fechaPagoIndex] || null
                            };
                        }
                        return socio;
                    }
                    return null;
                }).filter(s => s);

                if (sociosData.length > 0) {
                    showNotification(`Se cargaron ${sociosData.length} socios correctamente.`);
                    dniSearchInput.disabled = false;
                    dniSearchInput.placeholder = "Escribe para buscar...";
                } else {
                    showNotification("No se encontraron socios en la planilla online.", true);
                    dniSearchInput.placeholder = "Error al cargar datos";
                }
            } catch (error) {
                console.error("Error al cargar la planilla desde Google Sheets:", error);
                showNotification("No se pudo cargar la planilla. Revisa el enlace y la conexion.", true);
                dniSearchInput.placeholder = "Error de conexion";
            }
        });
        
        // --- Función para actualizar los campos de pago ---
        function updatePaymentFields(dni) {
            const socio = sociosData.find(s => s.dni === dni);
            const selectedMonth = document.getElementById('mesPago').value;

            if (socio && socio.pagos && socio.pagos[selectedMonth]) {
                const pagoMes = socio.pagos[selectedMonth];
                document.getElementById("cuota").value = pagoMes.cuota.trim() || "0";
                document.getElementById("donacion").value = pagoMes.donacion.trim() || "0";
                document.getElementById("fechaPago").value = formatExcelDate(pagoMes.fechaPago);
            } else {
                document.getElementById("cuota").value = "0";
                document.getElementById("donacion").value = "0";
                document.getElementById("fechaPago").valueAsDate = new Date();
            }
        }
        
        // --- Event Listener para el cambio de mes ---
        document.getElementById('mesPago').addEventListener('change', function() {
            const selectedDNI = document.getElementById('dniSearchInput').value;
            if (selectedDNI) {
                updatePaymentFields(selectedDNI);
            }
        });

        // --- Lógica de búsqueda autocompletable para DNI ---
        dniSearchInput.addEventListener("input", function() {
            const query = this.value.trim();
            dniSearchResults.innerHTML = '';
            if (query.length === 0) { return; }

            const filteredSocios = sociosData.filter(socio => String(socio.dni).startsWith(query));

            if (filteredSocios.length > 0) {
                dniSearchResults.classList.remove('hidden');
                filteredSocios.forEach(socio => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-200 cursor-pointer';
                    item.innerHTML = `<span class="font-bold">${socio.dni}</span> - ${socio.nombre}`;
                    item.addEventListener('click', () => {
                        dniSearchInput.value = socio.dni;
                        document.getElementById("nombre").value = socio.nombre || "";
                        document.getElementById("gradoCurso").value = socio.gradoCurso || "";
                        document.getElementById("telefonoSocio").value = socio.telefono || "";
                        updatePaymentFields(socio.dni); // Llama a la función para cargar datos de pago
                        dniSearchResults.classList.add('hidden');
                    });
                    dniSearchResults.appendChild(item);
                });
            } else {
                dniSearchResults.classList.add('hidden');
            }
        });
        
        window.addEventListener('click', function(e) {
            if (!document.getElementById('dniSearchInput').contains(e.target)) {
                dniSearchResults.classList.add('hidden');
            }
        });

        // --- Generar el recibo al enviar el formulario ---
        document.getElementById("reciboForm").addEventListener("submit", function(event) {
            event.preventDefault();
            
            const nombre = document.getElementById("nombre").value;
            const nroSocio = document.getElementById("dniSearchInput").value;
            const gradoCurso = document.getElementById("gradoCurso").value;
            const mesPago = document.getElementById("mesPago").value;
            const cuota = parseFloat(document.getElementById("cuota").value) || 0;
            const donacion = parseFloat(document.getElementById("donacion").value) || 0;
            const aportante = document.getElementById("aportante").value || nombre;
            const fechaInput = document.getElementById("fechaPago").value;
            const fecha = new Date(fechaInput + 'T00:00:00').toLocaleDateString("es-AR");
            const total = (cuota + donacion).toFixed(2);

            if (total <= 0) {
                showNotification("El total del recibo debe ser mayor a $0.", true);
                return;
            }
             if (!nombre) {
                showNotification("Por favor, seleccione un socio de la lista.", true);
                return;
            }
            
            const reciboHTML = `
                <div class="recibo-header text-center mb-6 pt-8">
                    <h3 class="font-bold text-xl">Asociacion Cooperadora Escuela Primaria Malvinas Argentinas</h3>
                </div>
                <h2 class="text-center font-bold text-2xl mb-4">RECIBO DE PAGO</h2>
                <div class="space-y-3 text-sm">
                    <p><strong>Fecha:</strong> ${fecha}</p>
                    <p><strong>Recibi de:</strong> ${aportante}</p>
                    <p><strong>La suma de:</strong> $${total}</p>
                    <hr class="my-2">
                    <p><strong>En concepto de:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        ${cuota > 0 ? `<li>Cuota social del mes de ${mesPago}: $${cuota.toFixed(2)}</li>` : ''}
                        ${donacion > 0 ? `<li>Donacion voluntaria: $${donacion.toFixed(2)}</li>` : ''}
                    </ul>
                    <hr class="my-2">
                    <p><strong>Socio DNI:</strong> ${nroSocio}</p>
                    <p><strong>Nombre del Socio:</strong> ${nombre}</p>
                    <p><strong>Grado y Curso:</strong> ${gradoCurso}</p>
                </div>
                <div class="mt-16 text-center">
                    <div class="border-2 border-blue-700 rounded-lg p-3 inline-block text-center">
                        <p class="text-blue-800 font-semibold text-xs leading-tight">Asociacion Cooperadora</p>
                        <p class="text-blue-800 font-bold text-sm leading-tight">Escuela Primaria Malvinas Argentinas</p>
                    </div>
                </div>
                <div class="text-center mt-8 text-xs text-gray-500 italic">
                    Recibo no valido como factura.
                </div>`;
            
            document.getElementById("recibo").innerHTML = reciboHTML;
            document.getElementById("reciboContainer").style.display = "block";
            
            window.datosRecibo = {
                mes: mesPago,
                nombre: nombre.replace(/\s+/g, '_')
            };
        });

        // --- Descargar el recibo como PDF ---
        async function descargarPDF() {
            const pdfBtn = document.getElementById('pdfBtn');
            const originalBtnText = pdfBtn.innerHTML;
            pdfBtn.innerHTML = 'Generando...';
            pdfBtn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF("p", "pt", "a4");
                const reciboElement = document.getElementById("recibo");

                const canvas = await html2canvas(reciboElement, { scale: 1.5 });
                const imgData = canvas.toDataURL("image/png");

                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 40;
                const imgWidth = pageWidth - margin * 2;
                const ratio = canvas.width / canvas.height;
                const imgHeight = imgWidth / ratio;
                
                doc.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight, undefined, 'FAST');

                const date = new Date();
                const timestamp = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}-${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
                const nombreArchivo = `recibo_${timestamp}_${window.datosRecibo.mes}_${window.datosRecibo.nombre}.pdf`;
                doc.save(nombreArchivo);
            } catch (error) {
                console.error("Error al generar el PDF:", error);
                showNotification("Error al generar el PDF. Revise la consola para mas detalles.", true);
            } finally {
                pdfBtn.innerHTML = originalBtnText;
                pdfBtn.disabled = false;
            }
        }

        // --- Enviar resumen por WhatsApp ---
        function enviarPorWhatsApp() {
            const telefono = document.getElementById('telefonoSocio').value;
            if (!telefono) {
                showNotification("Este socio no tiene un numero de telefono cargado.", true);
                return;
            }

            const nombre = document.getElementById("nombre").value;
            const mesPago = document.getElementById("mesPago").value;
            const cuota = parseFloat(document.getElementById("cuota").value);
            const donacion = parseFloat(document.getElementById("donacion").value);
            const total = (cuota + donacion).toFixed(2);
            const fecha = new Date(document.getElementById("fechaPago").value + 'T00:00:00').toLocaleDateString("es-AR");

            let concepto = "";
            if (cuota > 0) {
                concepto += `Cuota social del mes de ${mesPago}: $${cuota.toFixed(2)}`;
            }
            if (donacion > 0) {
                if (cuota > 0) concepto += "\n"; // Salto de línea si hay ambos
                concepto += `Donacion voluntaria: $${donacion.toFixed(2)}`;
            }

            // Formatear el mensaje para WhatsApp
            const mensaje = `*RECIBO DE PAGO - Cooperadora Malvinas Argentinas*
-----------------------------------
*Fecha:* ${fecha}
*Socio:* ${nombre}
*Concepto:*
${concepto}
-----------------------------------
*TOTAL PAGADO: $${total}*

_Este es un comprobante de pago. Recibo no valido como factura._`;

            const whatsappUrl = `https://wa.me/54${telefono}?text=${encodeURIComponent(mensaje)}`;
            
            // Abrir en una nueva pestaña
            window.open(whatsappUrl, '_blank');
        }

        // --- Función para limpiar el formulario y ocultar el recibo ---
        function limpiarFormulario() {
            document.getElementById("reciboForm").reset();
            document.getElementById("reciboContainer").style.display = "none";
            document.getElementById("nombre").value = "";
            document.getElementById("telefonoSocio").value = "";
            showNotification("Formulario limpiado.");
        }
    </script>
</body>
</html>
